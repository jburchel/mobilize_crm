{% extends 'base.html' %}

{% block title %}Church Details{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="header-left">
            <h2>Church Details</h2>
            <h1 class="church-name">{{ church.church_name }}</h1>
        </div>
        <div class="button-group">
            <a href="{{ url_for('churches_bp.edit_church', church_id=church.id) }}" class="button primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <button type="button" class="button" id="communicationButton" data-bs-toggle="modal" data-bs-target="#communicationModal">
                <i class="bi bi-chat-dots me-1"></i> Communication
            </button>
            <a href="{{ url_for('churches_bp.churches') }}" class="button">Back to Churches</a>
        </div>
    </div>

    <!-- Pipeline Visualization -->
    <div class="pipeline-container">
        <div class="pipeline-title">
            <i class="bi bi-diagram-3"></i>
            <span>Pipeline Progress</span>
        </div>
        <div class="pipeline-progress">
            <div class="pipeline-progress-bar" style="width: 
                {% if church.church_pipeline == 'PROMOTION' %}10%
                {% elif church.church_pipeline == 'INFORMATION' %}30%
                {% elif church.church_pipeline == 'INVITATION' %}50%
                {% elif church.church_pipeline == 'CONFIRMATION' %}70%
                {% elif church.church_pipeline == 'AUTOMATION' %}90%
                {% else %}0%{% endif %}">
            </div>
            
            <div class="pipeline-step {% if church.church_pipeline == 'PROMOTION' %}active{% elif church.church_pipeline in ['INFORMATION', 'INVITATION', 'CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">1</div>
                <div class="pipeline-step-label">Promotion</div>
            </div>
            
            <div class="pipeline-step {% if church.church_pipeline == 'INFORMATION' %}active{% elif church.church_pipeline in ['INVITATION', 'CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">2</div>
                <div class="pipeline-step-label">Information</div>
            </div>
            
            <div class="pipeline-step {% if church.church_pipeline == 'INVITATION' %}active{% elif church.church_pipeline in ['CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">3</div>
                <div class="pipeline-step-label">Invitation</div>
            </div>
            
            <div class="pipeline-step {% if church.church_pipeline == 'CONFIRMATION' %}active{% elif church.church_pipeline in ['AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">4</div>
                <div class="pipeline-step-label">Confirmation</div>
            </div>
            
            <div class="pipeline-step {% if church.church_pipeline == 'AUTOMATION' %}active{% endif %}">
                <div class="pipeline-step-marker">5</div>
                <div class="pipeline-step-label">Automation</div>
            </div>
        </div>
        
        {% if church.church_pipeline %}
        <div class="pipeline-info">
            <p>Current stage: <strong>{{ church.church_pipeline }}</strong>. 
            {% if church.church_pipeline == 'PROMOTION' %}
                This church is in the initial promotion stage. Focus on introducing them to the organization.
            {% elif church.church_pipeline == 'INFORMATION' %}
                This church is in the information gathering stage. Provide them with relevant materials.
            {% elif church.church_pipeline == 'INVITATION' %}
                This church is in the invitation stage. Invite them to relevant events or meetings.
            {% elif church.church_pipeline == 'CONFIRMATION' %}
                This church is in the confirmation stage. Follow up to confirm their participation.
            {% elif church.church_pipeline == 'AUTOMATION' %}
                This church is in the automation stage. Regular automated communications are in place.
            {% endif %}
            </p>
        </div>
        {% else %}
        <div class="pipeline-info">
            <p>
                No pipeline stage set. 
                <select id="quick-pipeline" class="inline-select">
                    <option value="">Select Pipeline Stage</option>
                    <option value="PROMOTION">PROMOTION</option>
                    <option value="INFORMATION">INFORMATION</option>
                    <option value="INVITATION">INVITATION</option>
                    <option value="CONFIRMATION">CONFIRMATION</option>
                    <option value="AUTOMATION">AUTOMATION</option>
                </select>
                <button id="quick-pipeline-btn" class="inline-button">Set</button>
            </p>
        </div>
        {% endif %}
    </div>

    <div class="content-container">
        <div class="row">
            <!-- Church Information Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-building"></i> Church Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <div class="info-label">Church Name:</div>
                            <div class="info-value">{{ church.church_name }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Email:</div>
                            <div class="info-value">{{ church.email or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Phone:</div>
                            <div class="info-value">{{ church.phone or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Website:</div>
                            <div class="info-value">
                                {% if church.website %}
                                    <a href="{{ church.website }}" target="_blank">{{ church.website }}</a>
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Address:</div>
                            <div class="info-value">
                                {% if church.street_address %}
                                    {{ church.street_address }}<br>
                                    {% if church.city or church.state or church.zip_code %}
                                        {{ church.city or '' }}{% if church.city and church.state %}, {% endif %}
                                        {{ church.state or '' }} {{ church.zip_code or '' }}<br>
                                    {% endif %}
                                    {{ church.country or '' }}
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Administrative Details Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-gear"></i> Administrative Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <div class="info-label">Pipeline Stage:</div>
                            <div class="info-value">{{ church.church_pipeline or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Priority:</div>
                            <div class="info-value">{{ church.priority or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Assigned To:</div>
                            <div class="info-value">{{ church.assigned_to or 'Unassigned' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Source:</div>
                            <div class="info-value">{{ church.source or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Referred By:</div>
                            <div class="info-value">{{ church.referred_by or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Denomination:</div>
                            <div class="info-value">{{ church.denomination or 'Not specified' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Notes Card -->
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-journal-text"></i> Notes</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-section">
                            <h4>Info Given</h4>
                            <p>{{ church.info_given or 'No information provided' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>Desired Service</h4>
                            <p>{{ church.desired_service or 'No information provided' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>Initial Notes</h4>
                            <p>{{ church.initial_notes or 'No notes available' }}</p>
                        </div>
                        {% if church.date_closed or church.reason_closed %}
                        <div class="info-section">
                            <h4>Closure Information</h4>
                            {% if church.date_closed %}
                            <p>Date Closed: {{ church.date_closed }}</p>
                            {% endif %}
                            {% if church.reason_closed %}
                            <p>Reason: {{ church.reason_closed }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- People from this Church Card -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-people"></i> People from this Church</h3>
                <a href="{{ url_for('people_bp.people') }}?church_id={{ church.id }}" class="button small">View All</a>
            </div>
            <div class="card-body">
                {% if church.people %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for person in church.people %}
                            <tr>
                                <td>{{ person.first_name }} {{ person.last_name }}</td>
                                <td>{{ person.church_role or 'Not specified' }}</td>
                                <td>{{ person.email or 'Not specified' }}</td>
                                <td>{{ person.phone or 'Not specified' }}</td>
                                <td>
                                    <a href="{{ url_for('people_bp.person_detail', person_id=person.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-4">No people associated with this church.</p>
                {% endif %}
            </div>
        </div>

        <!-- Recent Communications Card -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-chat-dots"></i> Recent Communications</h3>
                <a href="{{ url_for('communications_bp.all_communications_route', church_id=church.id) }}" class="button small">View All</a>
            </div>
            <div class="card-body">
                {% if recent_communications %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Subject</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comm in recent_communications %}
                            <tr>
                                <td>{% if comm.date_sent %}{{ comm.date_sent.strftime('%Y-%m-%d %H:%M') }}{% else %}N/A{% endif %}</td>
                                <td>{{ comm.type }}</td>
                                <td>
                                    <a href="{{ url_for('communications_bp.view_communication', comm_id=comm.id) }}">
                                        {{ comm.subject or 'N/A' }}
                                    </a>
                                </td>
                                <td>{% if comm.message %}{{ comm.message|truncate(50) }}{% else %}N/A{% endif %}</td>
                                <td>
                                    {% if comm.gmail_message_id %}
                                    <span class="badge bg-success">Sent</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Logged</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-4">No communications found for this church.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block styles %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.header-left h2 {
    font-size: 1.25rem;
    color: var(--text-color);
    margin: 0;
    opacity: 0.8;
}

.church-name {
    font-size: 2rem;
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
}

.button-group {
    display: flex;
    gap: 1rem;
}

.button {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
}

.button.small {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.button.primary {
    background-color: var(--primary-color);
    color: white;
}

.button.primary:hover {
    background-color: var(--secondary-color);
}

.button:not(.primary) {
    background-color: #fff;
    border-color: #ddd;
    color: var(--text-color);
}

.button:not(.primary):hover {
    background-color: #f9fafb;
    border-color: #c0c0c0;
}

.content-container {
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    background-color: #fff;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.info-row {
    display: flex;
    margin-bottom: 1rem;
}

.info-label {
    font-weight: 600;
    width: 40%;
    color: var(--text-color);
}

.info-value {
    width: 60%;
}

.info-section {
    margin-bottom: 1.5rem;
}

.info-section h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.info-section p {
    margin: 0;
    white-space: pre-line;
}

/* Pipeline styles */
.pipeline-container {
    background-color: #fff;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.pipeline-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.pipeline-progress {
    position: relative;
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
}

.pipeline-progress-bar {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    height: 4px;
    background-color: var(--primary-color);
    z-index: 1;
}

.pipeline-step {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
}

.pipeline-step-marker {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #fff;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.pipeline-step.active .pipeline-step-marker {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.pipeline-step.completed .pipeline-step-marker {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.pipeline-step-label {
    font-size: 0.875rem;
    font-weight: 500;
}

.pipeline-info {
    background-color: #f9fafb;
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-top: 1rem;
}

.pipeline-info p {
    margin: 0;
}

/* Inline dropdown and button styles */
.inline-select {
    display: inline-block;
    width: auto;
    padding: 0.25rem 0.5rem;
    margin: 0 0.5rem;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    background-color: white;
}

.inline-button {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
    background-color: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}

.inline-button:hover {
    background-color: var(--secondary-color);
}

/* Table styles */
.table {
    width: 100%;
    margin-bottom: 0;
}

.table th {
    font-weight: 600;
    color: var(--text-color);
}

.badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
    border-radius: 0.25rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    // More robust modal initialization
    var communicationBtn = document.getElementById('communicationButton');
    var communicationModalEl = document.getElementById('communicationModal');
    
    if (communicationBtn && communicationModalEl) {
        console.log('Found communication button and modal');
        
        // Try to initialize with Bootstrap's data attributes first
        // This is the preferred method in Bootstrap 5
        
        // Add a fallback click handler in case the data attributes don't work
        communicationBtn.addEventListener('click', function(e) {
            console.log('Communication button clicked');
            e.preventDefault();
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined') {
                console.log('Bootstrap is available');
                
                // Try to get existing modal instance
                var bsModal = bootstrap.Modal.getInstance(communicationModalEl);
                if (!bsModal) {
                    console.log('Creating new modal instance');
                    bsModal = new bootstrap.Modal(communicationModalEl);
                }
                
                // Show the modal
                bsModal.show();
                
                // Initialize the email fields visibility
                const typeSelect = document.getElementById('type');
                if (typeSelect && typeSelect.value === 'Email') {
                    const emailFields = document.getElementById('email-fields');
                    if (emailFields) {
                        emailFields.style.display = 'block';
                        fetchDefaultSignature();
                    }
                }
            } else {
                console.error('Bootstrap is not available');
            }
        });
    } else {
        console.error('Could not find modal or button elements');
    }
    
    // Quick pipeline selection
    const quickPipelineBtn = document.getElementById('quick-pipeline-btn');
    if (quickPipelineBtn) {
        quickPipelineBtn.addEventListener('click', function() {
            const quickPipeline = document.getElementById('quick-pipeline');
            const pipelineValue = quickPipeline.value;
            
            if (pipelineValue) {
                // Create a form to submit the pipeline update
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/update_church_pipeline/{{ church.id }}';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'church_pipeline';
                input.value = pipelineValue;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    // Communication form handling
    const typeSelect = document.getElementById('type');
    const emailFields = document.getElementById('email-fields');
    const signatureSelect = document.getElementById('signature_id');
    const sendBtn = document.getElementById('sendCommunicationBtn');
    const form = document.getElementById('churchCommunicationForm');
    const statusMessage = document.getElementById('statusMessage');
    
    // Show/hide email fields based on communication type
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            console.log('Communication type changed:', this.value);
            if (this.value === 'Email') {
                if (emailFields) {
                    emailFields.style.display = 'block';
                    // Fetch default signature when email type is selected
                    fetchDefaultSignature();
                }
                // Change button text for email
                if (sendBtn) {
                    sendBtn.textContent = 'Send Communication';
                }
            } else {
                if (emailFields) {
                    emailFields.style.display = 'none';
                }
                // Change button text for non-email
                if (sendBtn) {
                    sendBtn.textContent = 'Record Communication';
                }
            }
        });
        
        // Initialize the email fields on page load if Email is selected
        if (typeSelect.value === 'Email' && emailFields) {
            emailFields.style.display = 'block';
            fetchDefaultSignature();
            // Set initial button text
            if (sendBtn) {
                sendBtn.textContent = 'Send Communication';
            }
        } else {
            // Set initial button text for non-email
            if (sendBtn) {
                sendBtn.textContent = 'Record Communication';
            }
        }
    }
    
    // Function to load email signatures
    function loadSignatures() {
        fetch('/dashboard/api/email-signatures')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear existing options except the default one
                    while (signatureSelect.options.length > 1) {
                        signatureSelect.remove(1);
                    }
                    
                    // Add signatures to the select
                    data.signatures.forEach(signature => {
                        const option = document.createElement('option');
                        option.value = signature.id;
                        option.textContent = signature.name + (signature.is_default ? ' (Default)' : '');
                        signatureSelect.appendChild(option);
                    });
                } else {
                    console.error('Error loading signatures:', data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching signatures:', error);
            });
    }
    
    // Handle form submission
    if (form && sendBtn) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get communication type
            const commType = typeSelect.value;
            const isEmail = commType === 'Email';
            
            // Show loading state
            sendBtn.disabled = true;
            if (isEmail) {
                sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
            } else {
                sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Recording...';
            }
            
            // Clear previous status messages
            statusMessage.style.display = 'none';
            
            // Validate form
            const message = document.getElementById('message').value;
            
            if (!commType) {
                showError('Please select a communication type');
                return;
            }
            
            if (!message) {
                showError('Please enter a message');
                return;
            }
            
            // Get form data
            const formData = new FormData(form);
            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            
            // Send AJAX request
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                // Reset button state
                sendBtn.disabled = false;
                if (isEmail) {
                    sendBtn.innerHTML = 'Send Communication';
                } else {
                    sendBtn.innerHTML = 'Record Communication';
                }
                
                // Show status message
                statusMessage.style.display = 'block';
                
                if (data.success) {
                    // Success message
                    statusMessage.className = 'alert alert-success';
                    statusMessage.textContent = data.message;
                    
                    // Reset form after 2 seconds
                    setTimeout(() => {
                        form.reset();
                        emailFields.style.display = 'none';
                        statusMessage.style.display = 'none';
                        
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('communicationModal'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Reload page to show new communication
                        window.location.reload();
                    }, 2000);
                } else {
                    // Error message
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.textContent = data.message || (isEmail ? 'An error occurred while sending the communication.' : 'An error occurred while recording the communication.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Reset button state
                sendBtn.disabled = false;
                if (isEmail) {
                    sendBtn.innerHTML = 'Send Communication';
                } else {
                    sendBtn.innerHTML = 'Record Communication';
                }
                
                // Show error message
                statusMessage.style.display = 'block';
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = isEmail ? 'An error occurred while sending the communication. Please try again.' : 'An error occurred while recording the communication. Please try again.';
            });
        });
    }
    
    function showError(message) {
        statusMessage.style.display = 'block';
        statusMessage.className = 'alert alert-danger';
        statusMessage.textContent = message;
        
        // Reset button state
        sendBtn.disabled = false;
        const commType = typeSelect.value;
        if (commType === 'Email') {
            sendBtn.innerHTML = 'Send Communication';
        } else {
            sendBtn.innerHTML = 'Record Communication';
        }
    }

    // Fetch default signature when page loads
    fetchDefaultSignature();
    
    // Function to fetch the default signature
    function fetchDefaultSignature() {
        console.log('⚡ fetchDefaultSignature called');
        
        // Check if the textarea element exists
        const messageArea = document.getElementById('message');
        console.log('Message area found?', !!messageArea);
        if (!messageArea) {
            console.error('Message textarea not found when fetching signature');
            return; // Exit if the textarea doesn't exist
        }
        
        // Check if we're in email mode
        const typeSelect = document.getElementById('type');
        console.log('Type select found?', !!typeSelect, 'Value:', typeSelect ? typeSelect.value : 'not found');
        if (typeSelect && typeSelect.value !== 'Email') {
            console.log('Not in Email mode, skipping signature fetch');
            return; // Exit if not in email mode
        }
        
        fetch('/dashboard/api/email-signatures')
            .then(response => {
                console.log('Signature API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Signature data received:', JSON.stringify(data));
                if (data.success && data.signatures && data.signatures.length > 0) {
                    // Find the default signature
                    const defaultSignature = data.signatures.find(sig => sig.is_default);
                    console.log('Default signature found?', !!defaultSignature);
                    console.log('Default signature content exists?', defaultSignature && !!defaultSignature.content);
                    
                    if (defaultSignature && defaultSignature.content) {
                        // Set the signature_id input value
                        const signatureIdElement = document.getElementById('signature_id');
                        console.log('Signature ID element found?', !!signatureIdElement);
                        if (signatureIdElement) {
                            signatureIdElement.value = defaultSignature.id;
                            console.log('Default signature ID set:', defaultSignature.id);
                        } else {
                            console.error('signature_id input not found');
                        }
                        
                        // No longer adding plain text signature to the message textarea
                        // Instead, just show the HTML preview
                        
                        // Show HTML preview of the signature
                        const previewContainer = document.getElementById('signature-preview-container');
                        const previewContent = document.getElementById('signature-preview-content');
                        
                        if (previewContainer && previewContent) {
                            // Display the container
                            previewContainer.style.display = 'block';
                            
                            // Set the HTML content
                            previewContent.innerHTML = defaultSignature.content;
                            console.log('✅ Signature preview displayed with HTML formatting');
                        }
                    } else {
                        console.warn('No default signature content found');
                    }
                } else {
                    console.warn('No signatures available or API returned no success');
                }
            })
            .catch(error => {
                console.error('Error fetching signatures:', error);
            });
    }
});
</script>
{% endblock %}

{% block additional_content %}
<!-- Communication Modal -->
<div class="modal fade" id="communicationModal" tabindex="-1" aria-labelledby="communicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="communicationModalLabel">Send Communication to {{ church.church_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="churchCommunicationForm" action="{{ url_for('communications_bp.send_communication_route') }}" method="post">
                    <input type="hidden" name="church_id" value="{{ church.id }}">
                    <input type="hidden" id="signature_id" name="signature_id" value="">
                    
                    <div class="mb-3">
                        <label for="type" class="form-label">Communication Type</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="Phone Call">Phone Call</option>
                            <option value="Email">Email</option>
                            <option value="Text Message">Text Message</option>
                            <option value="In-Person Meeting">In-Person Meeting</option>
                            <option value="Video Call">Video Call</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div id="email-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Email Subject</label>
                            <input type="text" class="form-control" id="subject" name="subject" placeholder="Enter email subject">
                        </div>
                        
                        <div class="mb-3">
                            <label for="signature_id" class="form-label">Email Signature</label>
                            <select class="form-select" id="signature_id" name="signature_id">
                                <option value="">Use default signature</option>
                                <!-- Signatures will be loaded via AJAX -->
                            </select>
                            <div class="form-text">
                                <a href="{{ url_for('dashboard_bp.email_signatures') }}" target="_blank">
                                    <i class="bi bi-pencil-square"></i> Manage signatures
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">Message</label>
                        <textarea class="form-control" id="message" name="message" rows="5" required></textarea>
                    </div>
                    
                    <!-- Signature Preview -->
                    <div class="mb-3" id="signature-preview-container" style="display: none;">
                        <label class="form-label">Signature Preview:</label>
                        <div class="signature-preview p-3 border rounded bg-light">
                            <div id="signature-preview-content"></div>
                        </div>
                    </div>
                </form>
                
                <!-- Add a status message area -->
                <div id="statusMessage" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="sendCommunicationBtn">Send Communication</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
