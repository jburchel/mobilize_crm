{% extends 'base.html' %}

{% block title %}Person Details{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="header-left">
            <h2>Person Details</h2>
            <h1 class="person-name">{{ person.first_name }} {{ person.last_name }}</h1>
        </div>
        <div class="button-group">
            <a href="{{ url_for('people_bp.edit_person', person_id=person.id) }}" class="button primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <button type="button" class="button" id="communicationButton" data-bs-toggle="modal" data-bs-target="#communicationModal">
                <i class="bi bi-chat-dots me-1"></i> Communication
            </button>
            <a href="{{ url_for('people_bp.people') }}" class="button">Back to People</a>
        </div>
    </div>

    <!-- Pipeline Visualization -->
    <div class="pipeline-container">
        <div class="pipeline-title">
            <i class="bi bi-diagram-3"></i>
            <span>Pipeline Progress</span>
        </div>
        <div class="pipeline-progress">
            <div class="pipeline-progress-bar" style="width: 
                {% if person.people_pipeline == 'PROMOTION' %}10%
                {% elif person.people_pipeline == 'INFORMATION' %}30%
                {% elif person.people_pipeline == 'INVITATION' %}50%
                {% elif person.people_pipeline == 'CONFIRMATION' %}70%
                {% elif person.people_pipeline == 'AUTOMATION' %}90%
                {% else %}0%{% endif %}">
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'PROMOTION' %}active{% elif person.people_pipeline in ['INFORMATION', 'INVITATION', 'CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">1</div>
                <div class="pipeline-step-label">Promotion</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'INFORMATION' %}active{% elif person.people_pipeline in ['INVITATION', 'CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">2</div>
                <div class="pipeline-step-label">Information</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'INVITATION' %}active{% elif person.people_pipeline in ['CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">3</div>
                <div class="pipeline-step-label">Invitation</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'CONFIRMATION' %}active{% elif person.people_pipeline in ['AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">4</div>
                <div class="pipeline-step-label">Confirmation</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'AUTOMATION' %}active{% endif %}">
                <div class="pipeline-step-marker">5</div>
                <div class="pipeline-step-label">Automation</div>
            </div>
        </div>
        
        {% if person.people_pipeline %}
        <div class="pipeline-info">
            <p>Current stage: <strong>{{ person.people_pipeline }}</strong>. 
            {% if person.people_pipeline == 'PROMOTION' %}
                This person is in the initial promotion stage. Focus on introducing them to the organization.
            {% elif person.people_pipeline == 'INFORMATION' %}
                This person is in the information gathering stage. Provide them with relevant materials.
            {% elif person.people_pipeline == 'INVITATION' %}
                This person is in the invitation stage. Invite them to relevant events or meetings.
            {% elif person.people_pipeline == 'CONFIRMATION' %}
                This person is in the confirmation stage. Follow up to confirm their participation.
            {% elif person.people_pipeline == 'AUTOMATION' %}
                This person is in the automation stage. Regular automated communications are in place.
            {% endif %}
            </p>
        </div>
        {% else %}
        <div class="pipeline-info">
            <p>
                No pipeline stage set. 
                <select id="quick-pipeline" class="inline-select">
                    <option value="">Select Pipeline Stage</option>
                    <option value="PROMOTION">PROMOTION</option>
                    <option value="INFORMATION">INFORMATION</option>
                    <option value="INVITATION">INVITATION</option>
                    <option value="CONFIRMATION">CONFIRMATION</option>
                    <option value="EN42">EN42</option>
                    <option value="AUTOMATION">AUTOMATION</option>
                </select>
                <button id="quick-pipeline-btn" class="inline-button">Set</button>
            </p>
        </div>
        {% endif %}
    </div>

    <div class="content-container">
        <div class="row">
            <!-- Personal Information Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-person"></i> Personal Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <div class="info-label">Title:</div>
                            <div class="info-value">{{ person.title or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Email:</div>
                            <div class="info-value">{{ person.email or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Phone:</div>
                            <div class="info-value">{{ person.phone or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Preferred Contact:</div>
                            <div class="info-value">{{ person.preferred_contact_method or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Address:</div>
                            <div class="info-value">
                                {% if person.street_address %}
                                    {{ person.street_address }}<br>
                                    {% if person.city or person.state or person.zip_code %}
                                        {{ person.city or '' }}{% if person.city and person.state %}, {% endif %}
                                        {{ person.state or '' }} {{ person.zip_code or '' }}<br>
                                    {% endif %}
                                    {{ person.home_country or '' }}
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Church Information Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-building"></i> Church Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <div class="info-label">Church:</div>
                            <div class="info-value">
                                {% if person.church_id %}
                                    <a href="{{ url_for('churches_bp.church_detail', church_id=person.church_id) }}">
                                        {{ person.church.church_name }}
                                    </a>
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Role:</div>
                            <div class="info-value">{{ person.church_role or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Marital Status:</div>
                            <div class="info-value">{{ person.marital_status or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Spouse:</div>
                            <div class="info-value">
                                {% if person.spouse_first_name or person.spouse_last_name %}
                                    {{ person.spouse_first_name or '' }} {{ person.spouse_last_name or '' }}
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Administrative Details Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-gear"></i> Administrative Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <div class="info-label">Pipeline Stage:</div>
                            <div class="info-value">{{ person.people_pipeline or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Priority:</div>
                            <div class="info-value">{{ person.priority or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Assigned To:</div>
                            <div class="info-value">{{ person.assigned_to or 'Unassigned' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Source:</div>
                            <div class="info-value">{{ person.source or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Referred By:</div>
                            <div class="info-value">{{ person.referred_by or 'Not specified' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Virtuous:</div>
                            <div class="info-value">{{ 'Yes' if person.virtuous else 'No' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="bi bi-journal-text"></i> Notes</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-section">
                            <h4>Info Given</h4>
                            <p>{{ person.info_given or 'No information provided' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>Desired Service</h4>
                            <p>{{ person.desired_service or 'No information provided' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>Initial Notes</h4>
                            <p>{{ person.initial_notes or 'No notes available' }}</p>
                        </div>
                        {% if person.date_closed or person.reason_closed %}
                        <div class="info-section">
                            <h4>Closure Information</h4>
                            {% if person.date_closed %}
                            <p>Date Closed: {{ person.date_closed }}</p>
                            {% endif %}
                            {% if person.reason_closed %}
                            <p>Reason: {{ person.reason_closed }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Communications Card -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-chat-dots"></i> Recent Communications</h3>
                <a href="{{ url_for('communications_bp.all_communications_route') }}" class="button small">View All</a>
            </div>
            <div class="card-body">
                {% if recent_communications %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Subject</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comm in recent_communications %}
                            <tr>
                                <td>{{ comm.date_sent.strftime('%Y-%m-%d') }}</td>
                                <td>{{ comm.type }}</td>
                                <td>{{ comm.subject or 'N/A' }}</td>
                                <td>{{ comm.message|truncate(50) }}</td>
                                <td>
                                    {% if comm.gmail_message_id %}
                                    <span class="badge bg-success">Sent</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Logged</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-4">No communications found for this person.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block styles %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.header-left h2 {
    font-size: 1.25rem;
    color: var(--text-color);
    margin: 0;
    opacity: 0.8;
}

.person-name {
    font-size: 2rem;
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
}

.button-group {
    display: flex;
    gap: 1rem;
}

.button {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
}

.button.small {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.button.primary {
    background-color: var(--primary-color);
    color: white;
}

.button.primary:hover {
    background-color: var(--secondary-color);
}

.button:not(.primary) {
    background-color: #fff;
    border-color: #ddd;
    color: var(--text-color);
}

.button:not(.primary):hover {
    background-color: #f9fafb;
    border-color: #c0c0c0;
}

.content-container {
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    background-color: #fff;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.info-row {
    display: flex;
    margin-bottom: 1rem;
}

.info-label {
    font-weight: 600;
    width: 40%;
    color: var(--text-color);
}

.info-value {
    width: 60%;
}

.info-section {
    margin-bottom: 1.5rem;
}

.info-section h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.info-section p {
    margin: 0;
    white-space: pre-line;
}

/* Pipeline styles */
.pipeline-container {
    background-color: #fff;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.pipeline-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.pipeline-progress {
    position: relative;
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
}

.pipeline-progress-bar {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    height: 4px;
    background-color: var(--primary-color);
    z-index: 1;
}

.pipeline-step {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
}

.pipeline-step-marker {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #fff;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.pipeline-step.active .pipeline-step-marker {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.pipeline-step.completed .pipeline-step-marker {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.pipeline-step-label {
    font-size: 0.875rem;
    font-weight: 500;
}

.pipeline-info {
    background-color: #f9fafb;
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-top: 1rem;
}

.pipeline-info p {
    margin: 0;
}

/* Inline dropdown and button styles */
.inline-select {
    display: inline-block;
    width: auto;
    padding: 0.25rem 0.5rem;
    margin: 0 0.5rem;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    background-color: white;
}

.inline-button {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
    background-color: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}

.inline-button:hover {
    background-color: var(--secondary-color);
}

/* Table styles */
.table {
    width: 100%;
    margin-bottom: 0;
}

.table th {
    font-weight: 600;
    color: var(--text-color);
}

.badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
    border-radius: 0.25rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    // More robust modal initialization
    var communicationBtn = document.getElementById('communicationButton');
    var communicationModalEl = document.getElementById('communicationModal');
    
    if (communicationBtn && communicationModalEl) {
        console.log('Found communication button and modal');
        
        // Try to initialize with Bootstrap's data attributes first
        // This is the preferred method in Bootstrap 5
        
        // Add a fallback click handler in case the data attributes don't work
        communicationBtn.addEventListener('click', function(e) {
            console.log('Communication button clicked');
            e.preventDefault();
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined') {
                console.log('Bootstrap is available');
                
                // Try to get existing modal instance
                var bsModal = bootstrap.Modal.getInstance(communicationModalEl);
                if (!bsModal) {
                    console.log('Creating new modal instance');
                    bsModal = new bootstrap.Modal(communicationModalEl);
                }
                
                // Show the modal
                bsModal.show();
            } else {
                console.error('Bootstrap is not available');
            }
        });
    } else {
        console.error('Could not find modal or button elements');
    }
    
    // Quick pipeline selection
    const quickPipelineBtn = document.getElementById('quick-pipeline-btn');
    if (quickPipelineBtn) {
        quickPipelineBtn.addEventListener('click', function() {
            const quickPipeline = document.getElementById('quick-pipeline');
            const pipelineValue = quickPipeline.value;
            
            if (pipelineValue) {
                // Create a form to submit the pipeline update
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/update_pipeline/{{ person.id }}';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'people_pipeline';
                input.value = pipelineValue;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    // Communication form handling
    const typeSelect = document.getElementById('type');
    const emailFields = document.getElementById('email-fields');
    const signatureSelect = document.getElementById('signature_id');
    const sendBtn = document.getElementById('sendCommunicationBtn');
    const form = document.getElementById('personCommunicationForm');
    const statusMessage = document.getElementById('statusMessage');
    
    // Show/hide email fields based on communication type
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            if (this.value === 'Email') {
                emailFields.style.display = 'block';
                // Load signatures when email type is selected
                loadSignatures();
            } else {
                emailFields.style.display = 'none';
            }
        });
    }
    
    // Function to load email signatures
    function loadSignatures() {
        fetch('/dashboard/api/email-signatures')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear existing options except the default one
                    while (signatureSelect.options.length > 1) {
                        signatureSelect.remove(1);
                    }
                    
                    // Add signatures to the select
                    data.signatures.forEach(signature => {
                        const option = document.createElement('option');
                        option.value = signature.id;
                        option.textContent = signature.name + (signature.is_default ? ' (Default)' : '');
                        signatureSelect.appendChild(option);
                    });
                } else {
                    console.error('Error loading signatures:', data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching signatures:', error);
            });
    }
    
    // Handle form submission
    if (sendBtn && form) {
        sendBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
            
            // Get form data
            const formData = new FormData(form);
            
            // Convert FormData to JSON
            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            
            // Send AJAX request
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                // Reset button state
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send Communication';
                
                // Show status message
                statusMessage.style.display = 'block';
                
                if (data.success) {
                    // Success message
                    statusMessage.className = 'alert alert-success';
                    statusMessage.textContent = data.message;
                    
                    // Reset form after 2 seconds
                    setTimeout(() => {
                        form.reset();
                        emailFields.style.display = 'none';
                        statusMessage.style.display = 'none';
                        
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('communicationModal'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Reload page to show new communication
                        window.location.reload();
                    }, 2000);
                } else {
                    // Error message
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.textContent = data.message || 'An error occurred while sending the communication.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Reset button state
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send Communication';
                
                // Show error message
                statusMessage.style.display = 'block';
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = 'An error occurred while sending the communication.';
            });
        });
    }

    // Fetch default signature when page loads
    fetchDefaultSignature();
    
    // Function to fetch the default signature
    function fetchDefaultSignature() {
        fetch('/api/email-signatures')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.signatures) {
                    // Find the default signature
                    const defaultSignature = data.signatures.find(sig => sig.is_default);
                    if (defaultSignature) {
                        // Set the signature_id input value
                        document.getElementById('signature_id').value = defaultSignature.id;
                        console.log('Default signature set:', defaultSignature.name);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching signatures:', error);
            });
    }
});
</script>
{% endblock %}

{% block additional_content %}
<!-- Communication Modal -->
<div class="modal fade" id="communicationModal" tabindex="-1" aria-labelledby="communicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="communicationModalLabel">Send Communication to {{ person.first_name }} {{ person.last_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="personCommunicationForm" action="{{ url_for('communications_bp.send_communication_route') }}" method="post">
                    <input type="hidden" name="person_id" value="{{ person.id }}">
                    <input type="hidden" id="signature_id" name="signature_id" value="">
                    
                    <div class="mb-3">
                        <label for="type" class="form-label">Communication Type</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="">Select Communication Type</option>
                            <option value="Email">Email</option>
                            <option value="Phone">Phone</option>
                            <option value="In-Person">In-Person</option>
                            <option value="Video">Video</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="subject" name="subject" placeholder="Enter email subject">
                    </div>
                    
                    <div class="mb-3">
                        <label for="signature_id" class="form-label">Email Signature</label>
                        <select class="form-select" id="signature_id" name="signature_id">
                            <option value="">Use default signature</option>
                            <!-- Signatures will be loaded via AJAX -->
                        </select>
                        <div class="form-text">
                            <a href="{{ url_for('dashboard_bp.email_signatures') }}" target="_blank">
                                <i class="bi bi-pencil-square"></i> Manage signatures
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">Message</label>
                        <textarea class="form-control" id="message" name="message" rows="5" required></textarea>
                    </div>
                </form>
                
                <!-- Add a status message area -->
                <div id="statusMessage" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="sendCommunicationBtn">Send Communication</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
