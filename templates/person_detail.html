{% extends 'base.html' %}

{% block title %}Edit Person{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="header-left">
            <h2>Edit Person</h2>
            <h1 class="person-name">{{ person.first_name }} {{ person.last_name }}</h1>
        </div>
        <div class="button-group">
            <button type="submit" form="person-form" class="button primary">Save Changes</button>
            <a href="{{ url_for('people_bp.people') }}" class="button">Back to People</a>
        </div>
    </div>

    <!-- Pipeline Visualization -->
    <div class="pipeline-container">
        <div class="pipeline-title">
            <i class="bi bi-diagram-3"></i>
            <span>Pipeline Progress</span>
        </div>
        <div class="pipeline-progress">
            <div class="pipeline-progress-bar" style="width: 
                {% if person.people_pipeline == 'PROMOTION' %}10%
                {% elif person.people_pipeline == 'INFORMATION' %}30%
                {% elif person.people_pipeline == 'INVITATION' %}50%
                {% elif person.people_pipeline == 'CONFIRMATION' %}70%
                {% elif person.people_pipeline == 'AUTOMATION' %}90%
                {% else %}0%{% endif %}">
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'PROMOTION' %}active{% elif person.people_pipeline in ['INFORMATION', 'INVITATION', 'CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">1</div>
                <div class="pipeline-step-label">Promotion</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'INFORMATION' %}active{% elif person.people_pipeline in ['INVITATION', 'CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">2</div>
                <div class="pipeline-step-label">Information</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'INVITATION' %}active{% elif person.people_pipeline in ['CONFIRMATION', 'AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">3</div>
                <div class="pipeline-step-label">Invitation</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'CONFIRMATION' %}active{% elif person.people_pipeline in ['AUTOMATION'] %}completed{% endif %}">
                <div class="pipeline-step-marker">4</div>
                <div class="pipeline-step-label">Confirmation</div>
            </div>
            
            <div class="pipeline-step {% if person.people_pipeline == 'AUTOMATION' %}active{% endif %}">
                <div class="pipeline-step-marker">5</div>
                <div class="pipeline-step-label">Automation</div>
            </div>
        </div>
        
        {% if person.people_pipeline %}
        <div class="pipeline-info">
            <p>Current stage: <strong>{{ person.people_pipeline }}</strong>. 
            {% if person.people_pipeline == 'PROMOTION' %}
                This person is in the initial promotion stage. Focus on introducing them to the organization.
            {% elif person.people_pipeline == 'INFORMATION' %}
                This person is in the information gathering stage. Provide them with relevant materials.
            {% elif person.people_pipeline == 'INVITATION' %}
                This person is in the invitation stage. Invite them to relevant events or meetings.
            {% elif person.people_pipeline == 'CONFIRMATION' %}
                This person is in the confirmation stage. Follow up to confirm their participation.
            {% elif person.people_pipeline == 'AUTOMATION' %}
                This person is in the automation stage. Regular automated communications are in place.
            {% endif %}
            </p>
        </div>
        {% else %}
        <div class="pipeline-info">
            <p>No pipeline stage set. Select a pipeline stage to track this person's progress.</p>
        </div>
        {% endif %}
    </div>

    <form id="person-form" method="POST" action="/edit_person/{{ person.id }}">
        <div class="form-container">
            <!-- Personal Information Section -->
            <fieldset>
                <legend>Personal Information</legend>
                <div class="form-row">
                    <div class="form-field">
                        <label for="title">Title</label>
                        <input id="title" name="title" value="{{ person.title }}">
                    </div>
                    <div class="form-field">
                        <label for="first_name">First Name</label>
                        <input id="first_name" name="first_name" value="{{ person.first_name }}" required>
                    </div>
                    <div class="form-field">
                        <label for="last_name">Last Name</label>
                        <input id="last_name" name="last_name" value="{{ person.last_name }}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-field">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="{{ person.email }}">
                    </div>
                    <div class="form-field">
                        <label for="phone">Phone</label>
                        <input id="phone" name="phone" value="{{ person.phone }}">
                    </div>
                    <div class="form-field">
                        <label for="preferred_contact_method">Preferred Contact Method</label>
                        <select id="preferred_contact_method" name="preferred_contact_method">
                            <option value="">None</option>
                            <option value="email" {% if person.preferred_contact_method == 'email' %}selected{% endif %}>Email</option>
                            <option value="phone" {% if person.preferred_contact_method == 'phone' %}selected{% endif %}>Phone</option>
                            <option value="text" {% if person.preferred_contact_method == 'text' %}selected{% endif %}>Text</option>
                            <option value="facebook_messenger" {% if person.preferred_contact_method == 'facebook_messenger' %}selected{% endif %}>Facebook Messenger</option>
                            <option value="whatsapp" {% if person.preferred_contact_method == 'whatsapp' %}selected{% endif %}>Whatsapp</option>
                            <option value="groupme" {% if person.preferred_contact_method == 'groupme' %}selected{% endif %}>Groupme</option>
                            <option value="signal" {% if person.preferred_contact_method == 'signal' %}selected{% endif %}>Signal</option>
                            <option value="other" {% if person.preferred_contact_method == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- Address Section -->
            <fieldset>
                <legend>Address Information</legend>
                <div class="form-row">
                    <div class="form-field full-width">
                        <label for="street_address">Street Address</label>
                        <input id="street_address" name="street_address" value="{{ person.street_address }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="city">City</label>
                        <input id="city" name="city" value="{{ person.city }}">
                    </div>
                    <div class="form-field">
                        <label for="state">State</label>
                        <input id="state" name="state" value="{{ person.state }}">
                    </div>
                    <div class="form-field">
                        <label for="zip_code">Zip Code</label>
                        <input id="zip_code" name="zip_code" value="{{ person.zip_code }}">
                    </div>
                    <div class="form-field">
                        <label for="home_country">Home Country</label>
                        <input id="home_country" name="home_country" value="{{ person.home_country }}">
                    </div>
                </div>
            </fieldset>

            <!-- Church Information -->
            <fieldset>
                <legend>Church Information</legend>
                <div class="form-row">
                    <div class="form-field">
                        <label for="church_role">Church Role</label>
                        <select id="church_role" name="church_role">
                            <option value="Contact" {% if person.church_role == 'Contact' %}selected{% endif %}>Contact</option>
                            <option value="Member" {% if person.church_role == 'Member' %}selected{% endif %}>Member</option>
                            <option value="Leader" {% if person.church_role == 'Leader' %}selected{% endif %}>Leader</option>
                            <option value="Pastor" {% if person.church_role == 'Pastor' %}selected{% endif %}>Pastor</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="church_id">Church</label>
                        <select id="church_id" name="church_id">
                            <option value="">None</option>
                            {% for church in churches %}
                            <option value="{{ church.id }}" {% if person.church_id == church.id %}selected{% endif %}>{{ church.church_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- Family Information -->
            <fieldset>
                <legend>Family Information</legend>
                <div class="form-row">
                    <div class="form-field">
                        <label for="marital_status">Marital Status</label>
                        <select id="marital_status" name="marital_status">
                            <option value="">None</option>
                            <option value="single" {% if person.marital_status == 'single' %}selected{% endif %}>Single</option>
                            <option value="married" {% if person.marital_status == 'married' %}selected{% endif %}>Married</option>
                            <option value="divorced" {% if person.marital_status == 'divorced' %}selected{% endif %}>Divorced</option>
                            <option value="widowed" {% if person.marital_status == 'widowed' %}selected{% endif %}>Widowed</option>
                            <option value="separated" {% if person.marital_status == 'separated' %}selected{% endif %}>Separated</option>
                            <option value="engaged" {% if person.marital_status == 'engaged' %}selected{% endif %}>Engaged</option>
                            <option value="unknown" {% if person.marital_status == 'unknown' %}selected{% endif %}>Unknown</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="spouse_first_name">Spouse First Name</label>
                        <input id="spouse_first_name" name="spouse_first_name" value="{{ person.spouse_first_name }}">
                    </div>
                    <div class="form-field">
                        <label for="spouse_last_name">Spouse Last Name</label>
                        <input id="spouse_last_name" name="spouse_last_name" value="{{ person.spouse_last_name }}">
                    </div>
                </div>
            </fieldset>

            <!-- Administrative Information -->
            <fieldset>
                <legend>Administrative Details</legend>
                <div class="form-row">
                    <div class="form-field">
                        <label for="people_pipeline">Pipeline Stage</label>
                        <select id="people_pipeline" name="people_pipeline">
                            <option value="">None</option>
                            <option value="PROMOTION" {% if person.people_pipeline == 'PROMOTION' %}selected{% endif %}>Promotion</option>
                            <option value="INFORMATION" {% if person.people_pipeline == 'INFORMATION' %}selected{% endif %}>Information</option>
                            <option value="INVITATION" {% if person.people_pipeline == 'INVITATION' %}selected{% endif %}>Invitation</option>
                            <option value="CONFIRMATION" {% if person.people_pipeline == 'CONFIRMATION' %}selected{% endif %}>Confirmation</option>
                            <option value="AUTOMATION" {% if person.people_pipeline == 'AUTOMATION' %}selected{% endif %}>Automation</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="priority">Priority</label>
                        <select id="priority" name="priority">
                            <option value="">None</option>
                            <option value="urgent" {% if person.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                            <option value="high" {% if person.priority == 'high' %}selected{% endif %}>High</option>
                            <option value="medium" {% if person.priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="low" {% if person.priority == 'low' %}selected{% endif %}>Low</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="assigned_to">Assigned To</label>
                        <select id="assigned_to" name="assigned_to">
                            <option value="UNASSIGNED" {% if person.assigned_to == 'UNASSIGNED' %}selected{% endif %}>Unassigned</option>
                            <option value="BILL JONES" {% if person.assigned_to == 'BILL JONES' %}selected{% endif %}>Bill Jones</option>
                            <option value="JASON MODOMO" {% if person.assigned_to == 'JASON MODOMO' %}selected{% endif %}>Jason Modomo</option>
                            <option value="KEN KATAYAMA" {% if person.assigned_to == 'KEN KATAYAMA' %}selected{% endif %}>Ken Katayama</option>
                            <option value="MATTHEW RULE" {% if person.assigned_to == 'MATTHEW RULE' %}selected{% endif %}>Matthew Rule</option>
                            <option value="CHIP ATKINSON" {% if person.assigned_to == 'CHIP ATKINSON' %}selected{% endif %}>Chip Atkinson</option>
                            <option value="RACHEL LIVELY" {% if person.assigned_to == 'RACHEL LIVELY' %}selected{% endif %}>Rachel Lively</option>
                            <option value="JIM BURCHEL" {% if person.assigned_to == 'JIM BURCHEL' %}selected{% endif %}>Jim Burchel</option>
                            <option value="JILL WALKER" {% if person.assigned_to == 'JILL WALKER' %}selected{% endif %}>Jill Walker</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="source">Source</label>
                        <select id="source" name="source">
                            <option value="">None</option>
                            <option value="WEBFORM" {% if person.source == 'WEBFORM' %}selected{% endif %}>Webform</option>
                            <option value="INCOMING CALL" {% if person.source == 'INCOMING CALL' %}selected{% endif %}>Incoming Call</option>
                            <option value="EMAIL" {% if person.source == 'EMAIL' %}selected{% endif %}>Email</option>
                            <option value="SOCIAL MEDIA" {% if person.source == 'SOCIAL MEDIA' %}selected{% endif %}>Social Media</option>
                            <option value="COLD CALL" {% if person.source == 'COLD CALL' %}selected{% endif %}>Cold Call</option>
                            <option value="PERSPECTIVES" {% if person.source == 'PERSPECTIVES' %}selected{% endif %}>Perspectives</option>
                            <option value="REFERAL" {% if person.source == 'REFERAL' %}selected{% endif %}>Referral</option>
                            <option value="OTHER" {% if person.source == 'OTHER' %}selected{% endif %}>Other</option>
                            <option value="UNKNOWN" {% if person.source == 'UNKNOWN' %}selected{% endif %}>Unknown</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="referred_by">Referred By</label>
                        <input id="referred_by" name="referred_by" value="{{ person.referred_by }}">
                    </div>
                    <div class="form-field checkbox-field">
                        <label for="virtuous" class="checkbox-label">
                            <input type="checkbox" id="virtuous" name="virtuous" value="true" {% if person.virtuous %}checked{% endif %}>
                            <span>Virtuous</span>
                        </label>
                    </div>
                </div>
            </fieldset>

            <!-- Notes Section -->
            <fieldset>
                <legend>Notes & Additional Information</legend>
                <div class="form-row">
                    <div class="form-field full-width">
                        <label for="info_given">Info Given</label>
                        <textarea id="info_given" name="info_given">{{ person.info_given }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field full-width">
                        <label for="desired_service">Desired Service</label>
                        <textarea id="desired_service" name="desired_service">{{ person.desired_service }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field full-width">
                        <label for="initial_notes">Initial Notes</label>
                        <textarea id="initial_notes" name="initial_notes">{{ person.initial_notes }}</textarea>
                    </div>
                </div>
            </fieldset>

            <!-- Closure Information -->
            <fieldset>
                <legend>Closure Information</legend>
                <div class="form-row">
                    <div class="form-field">
                        <label for="date_closed">Date Closed</label>
                        <input type="date" id="date_closed" name="date_closed" value="{{ person.date_closed }}">
                    </div>
                    <div class="form-field full-width">
                        <label for="reason_closed">Reason Closed</label>
                        <textarea id="reason_closed" name="reason_closed">{{ person.reason_closed }}</textarea>
                    </div>
                </div>
            </fieldset>
        </div>
    </form>
{% endblock %}

{% block styles %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.header-left h2 {
    font-size: 1.25rem;
    color: var(--text-color);
    margin: 0;
    opacity: 0.8;
}

.person-name {
    font-size: 2rem;
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
}

.form-container {
    max-width: 1200px;
    margin: 0 auto;
}

fieldset {
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background-color: #fff;
}

legend {
    font-weight: 600;
    padding: 0 0.5rem;
    color: var(--primary-color);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.form-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-field.full-width {
    grid-column: 1 / -1;
}

.form-field label {
    font-weight: 500;
    color: var(--text-color);
}

.form-field input,
.form-field select,
.form-field textarea {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 1rem;
    width: 100%;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.form-field textarea {
    min-height: 100px;
    resize: vertical;
}

.checkbox-field {
    justify-content: center;
    flex-direction: row;
    align-items: center;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
}

.button-group {
    display: flex;
    gap: 1rem;
}

.button {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
}

.button.primary {
    background-color: var(--primary-color);
    color: white;
}

.button.primary:hover {
    background-color: var(--secondary-color);
}

.button:not(.primary) {
    background-color: #fff;
    border-color: #ddd;
    color: var(--text-color);
}

.button:not(.primary):hover {
    background-color: #f9fafb;
    border-color: #c0c0c0;
}
</style>
{% endblock %}
